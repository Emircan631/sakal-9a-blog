<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>ÅAKAL 9/A Tarih Blog - Åehit Aytekin Kuru Anadolu Lisesi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f5f5;
            color: #222;
        }

        /* ÃœST BANNER + BAÅLIK */
        header {
            text-align: center;
            background: #f0f8ff;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header img.banner {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            display: block;
        }

        header .header-text {
            padding: 10px 8px 14px 8px;
        }

        header h1 {
            font-size: 22px;
            margin-bottom: 4px;
            color: #1e4f8a;
        }

        header p {
            font-size: 14px;
            color: #3571af;
        }

        /* ANA KUTULAR */
        .container {
            max-width: 900px;
            margin: 0 auto 24px auto;
            padding: 0 12px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #2b6cb0;
        }

        label {
            display: block;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #1e4f8a;
        }

        input[type="text"],
        select,
        textarea,
        input[type="file"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .actions {
            margin-top: 12px;
            text-align: right;
        }

        button {
            background: #2b6cb0;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }

        button:hover { background: #24569a; }

        /* YAZILAR */
		.articles-empty {
            font-size: 14px;
            color: #666;
        }

        .article-item {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .article-title {
            font-weight: bold;
            font-size: 16px;
        }

        .article-meta {
            font-size: 12px;
            color: #555;
        }

        .article-content {
            margin-top: 6px;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .tag {
            display: inline-block;
            background: #edf2f7;
            color: #2b6cb0;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            margin-left: 4px;
        }

        .attachment-info {
            font-size: 12px;
            margin-top: 4px;
            color: #444;
        }

        .attachment-label {
            font-weight: bold;
        }

        .top-info {
            font-size: 13px;
            color: #555;
            margin-bottom: 6px;
        }

        .reset-btn {
            background: #e53e3e;
            margin-top: 8px;
        }

        .reset-btn:hover {
            background: #c53030;
        }

        /* Yorum alanÄ± */
        .comments-section {
            margin-top: 8px;
            padding: 8px 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: none; /* DEFAULT KAPALI */
        }

        .comments-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #2b6cb0;
        }

        .comment-item {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .comment-meta {
            font-weight: bold;
        }

        .comment-text {
            margin-left: 4px;
        }

        .comment-form {
            margin-top: 6px;
            border-top: 1px dashed #cbd5e0;
            padding-top: 6px;
        }

        .comment-form input[type="text"],
        .comment-form textarea {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .toggle-comments-btn {
            margin-top: 6px;
            background: #4a5568;
        }

        .toggle-comments-btn:hover {
            background: #2d3748;
        }

        .delete-btn {
            background: #e53e3e;
            margin-top: 6px;
            display: none; /* sadece admin-mode'da gÃ¶rÃ¼nsÃ¼n */
        }

        .delete-btn:hover {
            background: #c53030;
        }

        body.admin-mode .delete-btn {
            display: inline-block;
        }

        /* Admin panel butonu (sayfa altÄ±) */
        .admin-panel {
            text-align: center;
            margin: 10px 0 18px 0;
            font-size: 12px;
            color: #555;
        }

        .admin-panel button {
            padding: 6px 10px;
            font-size: 12px;
            background: #4a5568;
        }

        .admin-panel button:hover {
            background: #2d3748;
        }

        @media (max-width: 600px) {
            header h1 { font-size: 18px; }
            header p { font-size: 13px; }
        }
    </style>
</head>
<body>

<!-- ÃœST BANNER -->
<header>
    <!-- banner.png dosyan html ile aynÄ± klasÃ¶rde olmalÄ± -->
    <img src="banner.png" alt="T.C. MillÃ® EÄŸitim BakanlÄ±ÄŸÄ± - Åehit Aytekin Kuru Anadolu Lisesi" class="banner">

    <div class="header-text">
        <h1>Åehit Aytekin Kuru Anadolu Lisesi</h1>
        <p>ÅAKAL 9/A Tarih Blog - Ã–ÄŸrenci yazÄ±larÄ±, Ã§alÄ±ÅŸmalar ve yorumlar</p>
    </div>
</header>

<div class="container">
    <!-- Blog GÃ¶nderisi / YazÄ± Ekleme Formu -->
    <div class="card">
        <h2>Yeni Blog YazÄ±sÄ± Ekle</h2>
        <p class="top-info">
            Ã–ÄŸrenciler tarih konulu blog yazÄ±larÄ± yazarak ve dosya ekleyerek Ã§alÄ±ÅŸmalarÄ±nÄ± paylaÅŸabilir.
            TÃ¼m yazÄ±lar, dosya baÄŸlantÄ±larÄ± ve yorumlar Supabase veritabanÄ±nda saklanÄ±r ve herkes aynÄ± veriyi gÃ¶rÃ¼r.
        </p>

        <form id="article-form">
            <label for="student-name">Ã–ÄŸrenci AdÄ± SoyadÄ±</label>
            <input type="text" id="student-name" required placeholder="Ã–rn: AyÅŸe YÄ±lmaz" />

            <label for="article-title">YazÄ± / Blog BaÅŸlÄ±ÄŸÄ±</label>
            <input type="text" id="article-title" required placeholder="Ã–rn: Orta Ã‡aÄŸ'da YaÅŸam" />

            <label for="article-category">Kategori (isteÄŸe baÄŸlÄ±)</label>
            <select id="article-category">
                <option value="">SeÃ§iniz (isteÄŸe baÄŸlÄ±)</option>
                <option>Ä°lk Ã‡aÄŸ Tarihi</option>
                <option>Orta Ã‡aÄŸ Tarihi</option>
                <option>Yeni Ã‡aÄŸ Tarihi</option>
                <option>YakÄ±n Ã‡aÄŸ Tarihi</option>
                <option>T.C. Ä°nkÄ±lap Tarihi</option>
                <option>Genel Tarih / DiÄŸer</option>
            </select>

            <label for="article-content">YazÄ± Ä°Ã§eriÄŸi (Blog Metni)</label>
            <textarea id="article-content" required placeholder="Tarih konulu blog yazÄ±nÄ±zÄ± buraya yazÄ±n..."></textarea>

            <label for="article-attachment">Ã‡alÄ±ÅŸma / Dosya Ekle (isteÄŸe baÄŸlÄ±)</label>
            <input
                type="file"
                id="article-attachment"
                accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.txt"
            />

            <div class="actions">
                <button type="submit" id="submit-btn">YazÄ±yÄ± YayÄ±nla</button>
            </div>
        </form>
    </div>

    <!-- Blog GÃ¶nderileri Listesi -->
    <div class="card">
        <h2>PaylaÅŸÄ±lan Blog YazÄ±larÄ± ve Ã‡alÄ±ÅŸmalar</h2>
        <p class="top-info">
            AÅŸaÄŸÄ±da Supabase veritabanÄ±ndan Ã§ekilen tÃ¼m blog yazÄ±larÄ± listelenir.
            Dosya eklenmiÅŸse tÄ±klanabilir baÄŸlantÄ± olarak gÃ¶rÃ¼nÃ¼r.
            Yorumlar varsayÄ±lan kapalÄ±dÄ±r, â€œYorumlarÄ± GÃ¶sterâ€ ile aÃ§Ä±p kapatabilirsiniz.
        </p>

        <div id="articles-list"></div>

        <button class="reset-btn" id="reset-data">TÃ¼m YazÄ±larÄ± Sil (veritabanÄ±)</button>
    </div>
</div>

<!-- Sayfa AltÄ±nda KÃ¼Ã§Ã¼k Admin GiriÅŸi -->
<div class="admin-panel">
    <span>YÃ¶netici alanÄ±:</span>
    <button id="admin-login-btn">ğŸ”‘ Admin GiriÅŸi</button>
</div>

<!-- Supabase JS (v2) CDN -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    // Supabase baÄŸlantÄ± bilgileri
const SUPABASE_URL = "https://pjiycigxwctovojadtqj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqaXljaWd4d2N0b3ZvamFkdHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzkxNjAsImV4cCI6MjA4MDAxNTE2MH0.2LYwPmlv5H2s_qm7KBgHo_7SWRd19hMKk9F9QwBVnHQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Admin ayarlarÄ±
    const ADMIN_PASSWORD = "Ebola2005";
    let isAdmin = false;
    let openCommentsPostId = null; // hangi postun yorumlarÄ± aÃ§Ä±ksa saklayalÄ±m

    const form = document.getElementById("article-form");
    const submitBtn = document.getElementById("submit-btn");
    const articlesList = document.getElementById("articles-list");
    const resetBtn = document.getElementById("reset-data");
    const attachmentInput = document.getElementById("article-attachment");
    const adminLoginBtn = document.getElementById("admin-login-btn");

    // Admin GiriÅŸi
    adminLoginBtn.addEventListener("click", function () {
        const pwd = prompt("Admin ÅŸifresini giriniz:");
        if (pwd === ADMIN_PASSWORD) {
            isAdmin = true;
            document.body.classList.add("admin-mode");
            alert("Admin giriÅŸi baÅŸarÄ±lÄ±. ArtÄ±k yazÄ±larÄ± silebilirsiniz.");
        } else if (pwd !== null) {
            alert("HatalÄ± ÅŸifre!");
        }
    });

    // YazÄ±larÄ± ve yorumlarÄ± yÃ¼kle
    async function loadPosts() {
        articlesList.innerHTML = "<p>YazÄ±lar yÃ¼kleniyor...</p>";

        const { data: posts, error } = await supabase
            .from("posts")
            .select("*")
            .order("created_at", { ascending: false });

        if (error) {
            console.error(error);
            articlesList.innerHTML = "<p class='articles-empty'>YazÄ±lar yÃ¼klenirken hata oluÅŸtu.</p>";
            return;
        }

        if (!posts || posts.length === 0) {
            articlesList.innerHTML = "<p class='articles-empty'>HenÃ¼z hiÃ§ blog yazÄ±sÄ± eklenmedi.</p>";
            return;
        }

        // TÃ¼m post id'leri iÃ§in yorumlarÄ± tek seferde Ã§ek
        const postIds = posts.map((p) => p.id);
        const commentsMap = {};

        if (postIds.length > 0) {
            const { data: comments, error: cErr } = await supabase
                .from("comments")
                .select("*")
                .in("post_id", postIds)
                .order("created_at", { ascending: true });

            if (!cErr && comments) {
                comments.forEach((c) => {
                    if (!commentsMap[c.post_id]) commentsMap[c.post_id] = [];
                    commentsMap[c.post_id].push(c);
                });
            }
        }

        let html = "";
        posts.forEach((item) => {
            const commentsArr = commentsMap[item.id] || [];
            const commentCount = commentsArr.length;

            let commentsHtml = "";
            if (commentCount === 0) {
                commentsHtml = '<p class="articles-empty" style="margin-bottom:4px;">HenÃ¼z yorum yok.</p>';
            } else {
                commentsArr.forEach((c) => {
                    const dateStr = c.created_at
                        ? new Date(c.created_at).toLocaleString("tr-TR")
                        : "";
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="comment-meta">${c.author || "Ä°simsiz"}:</span>
                            <span class="comment-text">${c.text || ""}</span>
                            <span style="font-size:11px; color:#777;"> (${dateStr})</span>
                        </div>
                    `;
                });
            }

            const created = item.created_at
                ? new Date(item.created_at).toLocaleString("tr-TR")
                : "";

            html += `
                <div class="article-item" id="post-${item.id}">
                    <div class="article-header">
                        <div>
                            <span class="article-title">${item.title || ""}</span>
                            ${item.category ? `<span class="tag">${item.category}</span>` : ""}
                        </div>
                        <div class="article-meta">
                            ${item.student || ""} â€¢ ${created}
                        </div>
                    </div>
                    <div class="article-content">
                        ${makeLinksClickable(item.content || "")}
                    </div>

                    ${
                        item.attachment_url
                            ? `<div class="attachment-info">
                                   <span class="attachment-label">Ekli dosya:</span>
                                   <a href="${item.attachment_url}"
                                      target="_blank" rel="noopener noreferrer">
                                        ${item.attachment_name || "DosyayÄ± aÃ§"}
                                   </a>
                               </div>`
                            : ""
                    }

                    <button class="delete-btn"
                            onclick="deletePost('${item.id}')">
                        Bu YazÄ±yÄ± Sil
                    </button>

                    <button class="toggle-comments-btn"
                            onclick="toggleComments('${item.id}', this)">
                        YorumlarÄ± GÃ¶ster (${commentCount})
                    </button>

                    <div class="comments-section" id="comments-${item.id}">
                        <div class="comments-title">Yorumlar</div>
                        <div id="comments-list-${item.id}">
                            ${commentsHtml}
                        </div>

                        <form class="comment-form" onsubmit="return addComment(event, '${item.id}')">
                            <input type="text"
                                   id="comment-name-${item.id}"
                                   placeholder="AdÄ±nÄ±z (isteÄŸe baÄŸlÄ±)" />
                            <textarea id="comment-text-${item.id}"
                                      placeholder="Yorumunuz..."
                                      required></textarea>
                            <div style="text-align:right;">
                                <button type="submit" style="background:#3182ce;">Yorum GÃ¶nder</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        });

        articlesList.innerHTML = html;

        // EÄŸer Ã¶nceden aÃ§Ä±k olan bir yorum bÃ¶lÃ¼mÃ¼ varsa tekrar aÃ§
        if (openCommentsPostId) {
            const btn = document.querySelector(
                "#post-" + openCommentsPostId + " .toggle-comments-btn"
            );
            if (btn) {
                toggleComments(openCommentsPostId, btn, true);
            }
        }
    }

    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda yazÄ±larÄ± yÃ¼kle
    loadPosts();

    // Yeni yazÄ± ekle
    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const student = document.getElementById("student-name").value.trim();
        const title = document.getElementById("article-title").value.trim();
        const category = document.getElementById("article-category").value;
        const content = document.getElementById("article-content").value.trim();
        const attachmentFile = attachmentInput.files[0];

        if (!student || !title || !content) {
            alert("LÃ¼tfen Ã¶ÄŸrenci adÄ±, baÅŸlÄ±k ve iÃ§erik alanlarÄ±nÄ± doldurun.");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Kaydediliyor...";

        let attachment_name = null;
        let attachment_url = null;

        try {
            // EÄŸer dosya varsa Ã¶nce Storage'a yÃ¼kle
            if (attachmentFile) {
                const filePath = `${Date.now()}_${attachmentFile.name}`;

                const { error: uploadError } = await supabase
                    .storage
                    .from("attachments")
                    .upload(filePath, attachmentFile);

                if (uploadError) {
                    console.error(uploadError);
                    alert("Dosya yÃ¼klenirken hata oluÅŸtu.");
                } else {
                    const { data } = supabase
                        .storage
                        .from("attachments")
                        .getPublicUrl(filePath);

                    attachment_name = attachmentFile.name;
                    attachment_url = data.publicUrl;
                }
            }

            const { error: insertError } = await supabase.from("posts").insert({
                student,
                title,
                category,
                content,
                attachment_name,
                attachment_url
            });

            if (insertError) {
                console.error(insertError);
                alert("YazÄ± kaydedilirken hata oluÅŸtu.");
            } else {
                alert("Blog yazÄ±sÄ± baÅŸarÄ±yla eklendi.");
                form.reset();
                await loadPosts();
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "YazÄ±yÄ± YayÄ±nla";
        }
    });

    // YorumlarÄ± aÃ§/kapa
    function toggleComments(postId, btn, forceOpen) {
        const section = document.getElementById("comments-" + postId);
        if (!section) return;

        const isHidden = section.style.display === "" || section.style.display === "none";

        let willOpen = forceOpen ? true : isHidden;
        section.style.display = willOpen ? "block" : "none";

        const text = btn.innerText;
        if (willOpen) {
            btn.innerText = text.replace("GÃ¶ster", "Gizle");
            openCommentsPostId = postId;
        } else {
            btn.innerText = text.replace("Gizle", "GÃ¶ster");
            openCommentsPostId = null;
        }
    }

    // Yorum ekle


    async function addComment(e, postId) {
        // SayfanÄ±n yenilenmesini engelle
        if (e && e.preventDefault) {
            e.preventDefault();
        }

        const nameInput = document.getElementById("comment-name-" + postId);
        const textInput = document.getElementById("comment-text-" + postId);

        const author = (nameInput.value || "").trim() || "Ä°simsiz";
        const text = (textInput.value || "").trim();

        if (!text) {
            alert("LÃ¼tfen yorum metni girin.");
            return false;
        }

        const { error } = await supabase.from("comments").insert({
            post_id: postId,
            author,
            text
        });

        if (error) {
            console.error(error);
            alert("Yorum kaydedilirken hata oluÅŸtu.");
            return false;
        }

        // Formu temizle
        nameInput.value = "";
        textInput.value = "";

        // Bu postun yorumlarÄ± aÃ§Ä±k kalsÄ±n
        openCommentsPostId = postId;
        await loadPosts();

        return false; // formun submit etmesini yine de engelle
    }


    function makeLinksClickable(text) {
    if (!text) return "";

    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function (url) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
}




    // Tek bir yazÄ±yÄ± sil (sadece admin)
    async function deletePost(postId) {
        if (!isAdmin) {
            alert("Bu iÅŸlemi sadece admin yapabilir.");
            return;
        }

        if (!confirm("Bu blog yazÄ±sÄ±nÄ± ve tÃ¼m yorumlarÄ±nÄ± silmek istediÄŸinize emin misiniz?")) {
            return;
        }

        // Ã–nce yorumlarÄ±, sonra yazÄ±yÄ± sil
        const { error: cErr } = await supabase
            .from("comments")
            .delete()
            .eq("post_id", postId);

        if (cErr) {
            console.error(cErr);
            alert("Yorumlar silinirken hata oluÅŸtu.");
            return;
        }

        const { error: pErr } = await supabase
            .from("posts")
            .delete()
            .eq("id", postId);

        if (pErr) {
            console.error(pErr);
            alert("YazÄ± silinirken hata oluÅŸtu.");
            return;
        }

        alert("YazÄ± ve yorumlarÄ± silindi.");
        await loadPosts();
    }

    // TÃ¼m yazÄ±larÄ± sil (sadece admin)
    resetBtn.addEventListener("click", async function () {
        if (!isAdmin) {
            alert("TÃ¼m yazÄ±larÄ± silme iÅŸlemi sadece admin iÃ§in geÃ§erlidir.");
            return;
        }

        if (!confirm("TÃ¼m blog yazÄ±larÄ±nÄ± ve yorumlarÄ± veritabanÄ±ndan silmek istediÄŸinize emin misiniz?")) {
            return;
        }

        const { error: cErr } = await supabase.from("comments").delete().neq("id", null);
        if (cErr) {
            console.error(cErr);
            alert("Yorumlar silinirken hata oluÅŸtu.");
            return;
        }

        const { error: pErr } = await supabase.from("posts").delete().neq("id", null);
        if (pErr) {
            console.error(pErr);
            alert("YazÄ±lar silinirken hata oluÅŸtu.");
            return;
        }

        alert("TÃ¼m yazÄ±lar ve yorumlar silindi.");
        loadPosts();
    });
</script>

</body>
</html>
